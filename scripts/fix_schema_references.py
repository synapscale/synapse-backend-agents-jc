#!/usr/bin/env python3
"""
Script para corrigir todas as referÃªncias de schema nas migraÃ§Ãµes do Alembic,
trocando 'public' por 'synapscale_db'.

Este script:
1. Localiza todas as ocorrÃªncias de schema='public' no arquivo de migraÃ§Ã£o
2. Substitui por schema='synapscale_db'
3. Corrige referÃªncias em ForeignKeyConstraint que apontam para public
4. Corrige referÃªncias em Ã­ndices (create_index)

O objetivo Ã© garantir que todas as tabelas sejam criadas no schema correto.
"""

import os
import re
from pathlib import Path


def fix_migration_file(filepath):
    """Corrige as referÃªncias de schema em um arquivo de migraÃ§Ã£o."""
    with open(filepath, 'r') as file:
        content = file.read()

    # Contador para acompanhar o nÃºmero de alteraÃ§Ãµes
    changes = 0

    # 1. Substituir schema='public' por schema='synapscale_db'
    pattern = r"schema='public'"
    replacement = r"schema='synapscale_db'"
    content, count = re.subn(pattern, replacement, content)
    changes += count
    print(f"- SubstituÃ­das {count} ocorrÃªncias de schema='public' por schema='synapscale_db'")

    # 2. Corrigir referÃªncias em ForeignKeyConstraint
    pattern = r"\['public\.(.*?)\.(.*?)'\]"
    replacement = r"['synapscale_db.\1.\2']"
    content, count = re.subn(pattern, replacement, content)
    changes += count
    print(f"- SubstituÃ­das {count} ocorrÃªncias de referÃªncias ForeignKeyConstraint para public")

    # 3. Corrigir referÃªncias em create_index
    pattern = r"op\.f\('ix_public_(.*?)'\)"
    replacement = r"op.f('ix_synapscale_db_\1')"
    content, count = re.subn(pattern, replacement, content)
    changes += count
    print(f"- SubstituÃ­das {count} ocorrÃªncias de referÃªncias ix_public em create_index")

    # 4. Corrigir referÃªncias em drop_index
    pattern = r"table_name='(.*?)', schema='public'"
    replacement = r"table_name='\1', schema='synapscale_db'"
    content, count = re.subn(pattern, replacement, content)
    changes += count
    print(f"- SubstituÃ­das {count} ocorrÃªncias de schema='public' em drop_index")

    # 5. Corrigir comentÃ¡rios com "public" schema
    pattern = r"# ### commands auto generated by Alembic - public schema"
    replacement = r"# ### commands auto generated by Alembic - synapscale_db schema"
    content, count = re.subn(pattern, replacement, content)
    changes += count

    # Salvar o arquivo atualizado
    with open(filepath, 'w') as file:
        file.write(content)

    return changes


def main():
    """FunÃ§Ã£o principal."""
    print("ğŸ” Procurando arquivo de migraÃ§Ã£o para corrigir...")
    
    # Obter o diretÃ³rio base
    base_dir = Path(__file__).parent.parent
    versions_dir = base_dir / "alembic" / "versions"
    
    # Encontrar o arquivo de migraÃ§Ã£o init.py
    target_file = versions_dir / "294dba6f3a38_init.py"
    
    if not target_file.exists():
        print(f"âŒ Arquivo de migraÃ§Ã£o {target_file} nÃ£o encontrado!")
        return
    
    print(f"âœ… Arquivo de migraÃ§Ã£o encontrado: {target_file}")
    print("\nğŸ”§ Corrigindo referÃªncias de schema...")
    
    # Corrigir o arquivo
    changes = fix_migration_file(target_file)
    
    print(f"\nâœ… ConcluÃ­do! {changes} alteraÃ§Ãµes feitas no arquivo de migraÃ§Ã£o.")
    print("\nAgora vocÃª pode executar o comando de migraÃ§Ã£o para aplicar as alteraÃ§Ãµes:")
    print("  cd /workspaces/synapse-backend-agents-jc")
    print("  python -m alembic -c config/alembic.ini upgrade head")


if __name__ == "__main__":
    main()
